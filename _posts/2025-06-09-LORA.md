---
layout: post
title: "π“ Understanding LORA- LORA μ•μ•„λ³΄κΈ°?!!"
author: [DrFirst]
date: 2025-06-09 07:00:00 +0900
categories: [AI, Research]
tags: [LORA, fine-tuning, ICLR, ICLR 2022, Low-Rank Adaptation, Parameter Efficiency]
sitemap :
  changefreq : monthly
  priority : 0.8
---


---

## π§  (ν•κµ­μ–΄) LORA : LLMμ„ μ„ν• μ €λ­ν¬ νμΈνλ‹ κΈ°λ²•  
_π” κ°€λ³κ³  λΉ λ¥΄κ²!! Fine-tuningμ μƒλ΅μ΄ λ°©λ²•λ΅  μ μ‹!_

> λ…Όλ¬Έ: [LoRA: Low-Rank Adaptation of Large Language Models](https://arxiv.org/abs/2106.09685)  
> λ°ν‘: ICLR 2022   (Edward J. Hu et al. - Microsoft Research)  
> μ½”λ“: [microsoft/LORA](https://github.com/microsoft/LoRA)  
> μ½”λ©νΈ: LLMμ μ–Έμ–΄ μ΄ν•΄ λ¥λ ¥μ„ μ‹κ° λ¶„ν• μ— μ ‘λ©ν• νκΈ°μ μΈ μ ‘κ·Ό!


---

### π“ μ”μ•½

μ—„μ²­ μΆ‹μ€ LLM μ„ μ΅°κΈ μμ •ν•κ³ μ‹¶μ„λ–„!!  
κΈ°μ΅΄ λ°©λ²•λ“¤μ€ LLMλ§λ“¤λ•μ™€ μ μ‚¬ν• μΈν”„λΌλ¥Ό κ°€μ§€κ³  λ―Έμ„Έ μ΅°μ •(fine-tuning)μ„ ν•΄μ•Όν–μµλ‹λ‹¤!!  
μ™λƒν•λ©΄ κΈ°μ΅΄ λ°©μ‹μ€ `full fine-tuning λ°©μ‹`μΌλ΅,  
μμ‹­μ–µ κ°μ νλΌλ―Έν„°λ¥Ό μ—…λ°μ΄νΈν•΄μ•Ό ν–κΈ° λ–„λ¬Έμ…λ‹λ‹¤!  

ν•μ§€λ§ LoRAλ”! μ΄λ° λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ°μ„ν•΄ λ“±μ¥ν• λ―Έμ„Έμ΅°μ • κΈ°λ²•μΌλ΅!   
**ν›¨μ”¬ μ μ€ νλΌλ―Έν„°λ§ μ¶”κ°€ ν•™μµ**ν•λ©΄μ„λ„ λΉ„μ·ν•κ±°λ‚ λ” μΆ‹μ€ μ„±λ¥μ„ λ‹¬μ„±ν•©λ‹λ‹¤.

> π― ν•µμ‹¬ μ•„μ΄λ””μ–΄!!  
> π‘‰ "κΈ°μ΅΄ λ¨λΈ κ°€μ¤‘μΉλ” κ³ μ •ν•κ³ , **λ’·λ¶€λ¶„μ— μ¶”κ°€λ λ‹¤λ¥Έ λ¶€λ¶„**(μ €λ­ν¬ ν–‰λ ¬, Low-Rank Matrices)λ§ ν•™μµν•λ‹¤!"

---

### π§  LORA λ“±μ¥μ λ°°κ²½


#### π“ λ¬Έμ μμ‹: λ€κ·λ¨ LLMμ ν•κ³„

- μµκ·Ό μ–Έμ–΄ λ¨λΈ(GPT λ“±)μ€ μμ‹­μ–µ~μμ²μ–µ κ°μ νλΌλ―Έν„°λ¥Ό κ°€μ§€λ©°, μ΄λ¥Ό **μ „μ²΄ νμΈνλ‹(fine-tuning)** ν•λ” κ²ƒμ€ λ§¤μ° λΉ„ν¨μ¨μ   
- νƒμ¤ν¬λ§λ‹¤ λ³„λ„λ΅ λ¨λΈ νλΌλ―Έν„°λ¥Ό ν•™μµν•΄μ•Ό ν•λ©°, μ΄λ” μ›λ³Έ νλΌλ―Έν„° \( \Phi_0 \) μ™€ **λ™μΌν• ν¬κΈ°**μ΄κΈ° λ•λ¬Έμ—:
  - π’Ύ **μ €μ¥ κ³µκ°„**: νƒμ¤ν¬ μλ§νΌ GPT-3 μμ¤€μ λ¨λΈμ„ λ³„λ„λ΅ μ €μ¥ν•΄μ•Ό ν•¨
  - π€ **λ°°ν¬/μ΄μ**: λ¨λΈ μ „ν™ λΉ„μ©μ΄ μ»¤μ§€κ³  μ‹¤μ‹κ°„ μ„λΉ„μ¤μ— λ¶€μ ν•©
  - π’Έ **ν•™μµ μμ›**: GPU λ©”λ¨λ¦¬μ™€ μ—°μ‚°λΉ„μ©μ΄ κ³Όλ„ν•κ² μ¦κ°€

---

#### π’΅ κΈ°μ΅΄ μ ‘κ·Ό λ°©μ‹μ ν•κ³„

1. **μ–΄λ‘ν„° λ μ΄μ–΄ (Adapter Layers)**  
   - Transformer λΈ”λ΅ μ‚¬μ΄μ— μ‘μ€ λ³‘λ© λ„¤νΈμ›ν¬(bottleneck)λ¥Ό μ‚½μ…ν•μ—¬ μ μ€ μμ νλΌλ―Έν„°λ§ ν•™μµ
   - β… μ¥μ : μ μ€ νλΌλ―Έν„° ν•™μµ   
   - β λ‹¨μ :
     - μ–΄λ‘ν„° μ—°μ‚°μ€ **μμ°¨μ μΌλ΅ μν–‰**λλ―€λ΅ **μ¶”λ΅  μ§€μ—°(latency)** μ΄ λ°μƒ  
     - μ‹¤μ‹κ°„ μ¨λΌμΈ ν™κ²½(μ: λ°°μΉ ν¬κΈ° 1)μ—μ„  μ„±λ¥ μ €ν• λλ ·  
     - λ¨λΈ λ³‘λ ¬ν™”(sharding) ν™κ²½μ—μ„ **ν†µμ‹  λΉ„μ© μ¦κ°€**  

2. **ν”„λ΅¬ν”„νΈ κΈ°λ° μ΅°μ • (Prompt Tuning / Prefix Tuning)**  
   - μ…λ ¥ ν† ν° μ•μ— ν•™μµ κ°€λ¥ν• ν”„λ΅¬ν”„νΈλ¥Ό μ‚½μ…ν•μ—¬ μ΅°μ •
   - β… μ¥μ : λ¨λΈ κµ¬μ΅° λ³€κ²½ μ—†μ  
   - β λ‹¨μ :
     - μµμ ν™”κ°€ **λ¶μ•μ •**ν•κ³  μ„±λ¥μ΄ **λΉ„μ„ ν•μ μΌλ΅ λ³€ν™”**  
     - ν”„λ΅¬ν”„νΈκ°€ μ…λ ¥ κΈΈμ΄λ¥Ό μ°¨μ§€ν•΄ **μ²λ¦¬ κ°€λ¥ν• μ‹ν€€μ¤ κΈΈμ΄ κ°μ†**  

---

#### π€ LoRAμ ν•µμ‹¬ λ™κΈ°

- μ„μ λ°©μ‹λ“¤μ€ ν¨μ¨μ„±μ„ μ κ³µν•μ§€λ§, μ‹¤μ©μ„±κ³Ό μ„±λ¥ κ°„ **νΈλ μ΄λ“μ¤ν”„κ°€ μ΅΄μ¬**
- **LoRA (Low-Rank Adaptation)** λ” λ‹¤μμ κ΄€μ°°μ—μ„ μ¶λ°ν•¨:
  - λ€ν• λ¨λΈμ νμΈνλ‹ μ‹, μ‹¤μ λ΅ λ³€κ²½λλ” νλΌλ―Έν„°μ λ³€ν™”λ” **μ €μ°¨μ› κ³µκ°„**μ— μ΅΄μ¬ν•¨
- λ”°λΌμ„,
  - μ „μ²΄ κ°€μ¤‘μΉ λ€μ‹  **λ³€ν™”λ‰(β†W)μ„ μ €λ­ν¬ ν–‰λ ¬ \( A, B \) λ΅ λ¶„ν•΄**ν•μ—¬ ν•™μµ
  - μ‚¬μ „ν•™μµλ κ°€μ¤‘μΉλ” **κ³ μ •(freeze)** ν•μ—¬ ν¨μ¨μ μΈ μ—…λ°μ΄νΈ κ°€λ¥
  - κ²°κ³Όμ μΌλ΅ **λ©”λ¨λ¦¬Β·κ³„μ‚° μμ› μ κ° + μ„±λ¥ μ μ§€ + μ¶”λ΅  μ§€μ—° μ—†μ**

---

### π—οΈ λ°©λ²•λ΅ : Low-Rank Adaptation (LoRA)

#### π’΅ Low-Rank-Parametrized Update Matrices (μ €λ­ν¬μ ν–‰λ ¬ μ—…λ°μ΄νΈ)

![Image](https://github.com/user-attachments/assets/96e90b1a-c457-4ee2-9b4a-c75dd12f7fe9)

λ¨λΈμ weight ν–‰λ ¬ `W`λ¥Ό μ§μ ‘ μ—…λ°μ΄νΈν•λ” λ€μ‹ ,  
μ•„λκ³Ό κ°™μ΄ **μ €λ­ν¬ ν–‰λ ¬μ κ³±μΌλ΅ λ€μ²΄**  

```
W' = W + Ξ”W = W + BA
```

- `A β β„^{rΓ—d}`   : μ •κ·λ¶„ν¬λ΅ μ΄κΈ°ν™”    
- `B β β„^{dΓ—r}`   : μ²μμ—” 0μΌλ΅ μ„¤μ •  
- `r β‰ d`: μ¦‰, μ €λ­ν¬(rank-r) κµ¬μ΅°  
- `W`λ” κ³ μ •(frozen), `A`, `B`λ§ ν•™μµ

μ΄λ ‡κ² ν•¨μΌλ΅μ¨!  
**ν›λ ¨ νλΌλ―Έν„° μμ™€ μ—°μ‚°λ‰μ„ λ€ν­ μ¤„μ΄κ³ ** μ†λ„&μ„±λ¥λ„ μ μ§€!!  

μ¶”κ°€λ΅! κ·ΈλΌ μ–΄λ–¤ μ°¨μ›(r)μΌλ΅ λ‚®μ¶”λ”κ²ƒ κΉμ§€ κ°€λ¥ν• κΉ?  
λ‚®μΌλ©΄ λ‚®μ„μλ΅ λ¦¬μ†μ¤λ” μ κ²λ“¤μ§€λ§ ν•™μµμ΄ λ κΉ κ±±μ •λκΈ°μ—!~  
ν•΄λ‹Ή κ³ λ―Όλ„ μ—°κµ¬μ λ’·λ¶€λ¶„  `7.2 WHAT IS THE OPTIMAL RANK r FOR LORA?`  μ— λ‚μ™”μµλ‹λ‹¤!!
κ²°λ΅ λ§ λ§ν•λ©΄ rμ΄ 1μΌλ–„λ„ κ½¤ μ„±λ¥μ΄ κ΄μ°®μ•λ°μ”!  
> λν• r=8 μ΄λ‘ r=64μΌλ–„μ λ²΅ν„°λ¥Ό κµ¬ν•΄μ„ μ–Όλ§λ‚ κ²ΉμΉλ”μ§€λ¥Ό μ‹κ°ν™”ν–λ”λ°, λ§μ΄ κ²ΉμΉλ”κ²ƒμ„ ν™•μΈν–λ€μ”!  
![Image](https://github.com/user-attachments/assets/2a17d563-8087-498d-9ced-044d8131013b) 


#### β–¶οΈ Forward Pass μμ • (κ²°κ³Όκ°‘ μμΈ΅ λ°©λ²• μμ •)  

- κΈ°μ΅΄:  `h = W_0 * x`
- LoRA μ μ© ν›„: ` h = W_0*x + BA*x`
  οΈβ†’ λ™μΌ μ…λ ¥μ— λ€ν•΄ λ‘ μ¶λ ¥ κ³„μ‚° ν›„ **μΆν‘λ³„ ν•©μ‚°**  
  (`W_0*x` μ™€ `BA*x`λ” κ°™μ€ μ°¨μ›μ λ²΅ν„°λ΅ λ”ν•κΈ°κ°€ κ°€λ¥μ“°!)

---

### Transformerμ— LoRAλ¥Ό μ μ©ν•λ©΄@?  


#### π”§ μ μ© λ€μƒ

- **Self-Attention λ¨λ“** λ‚΄ κ°€μ¤‘μΉ ν–‰λ ¬:
  - \( W_q \): Query
  - \( W_k \): Key
  - \( W_v \): Value
  - \( W_o \): Output

- **MLP λ¨λ“**μ—λ” Dense Layer 2κ° μ΅΄μ¬

> μ‹¤ν—μ—μ„λ” \( W_q \), \( W_k \), \( W_v \) μ¤‘ ν•λ‚λ¥Ό \( d_{model} \times d_{model} \) ν¬κΈ°μ λ‹¨μΌ ν–‰λ ¬λ΅ μ·¨κΈ‰  
> (μ‹¤μ λ΅λ” μ—¬λ¬ attention headλ΅ λ¶„ν• λμ§€λ§,, λ‹¨μν™”λ¥Ό μ„ν•μ—¬!!)  
> LoRA λ…Όλ¬Έμ—μ„λ” μ‹¤ν—μ μΌλ΅ λ‹¤μ–‘ν• μ΅°ν•©μ„ ν…μ¤νΈν–κ³ , Wqμ™€ Wvμ— μ μ©ν•λ”κ²ƒμ΄ λ€ν‘μ μ„!  

> `7.2 WHAT IS THE OPTIMAL RANK r FOR LORA?` μ—μ„ ν•΄λ‹Ή μ‹¤ν—λ‚΄μ©μ„ λ³Όμ μμ§€μ”~~  
![Image](https://github.com/user-attachments/assets/113caa55-a1d6-419e-a729-cc9d5ec02e6a)

---

#### β™οΈ μ‹¤ν— μ „λµ

- **Attention weightsλ§ LoRAλ΅ ν•™μµ**  
- **MLP, LayerNorm, Biasλ” λ¨λ‘ κ³ μ •(freeze)**  
β†’ κ°„λ‹¨ν•κ³  νλΌλ―Έν„° ν¨μ¨μ 

---

#### β… LoRAμ μ‹¤μ©μ  μ΄μ 

- **λ©”λ¨λ¦¬ μ κ°**:  
  - GPT-3 175B κΈ°μ¤€ VRAM μ‚¬μ©λ‰  
    β†’ μ „μ²΄ νμΈνλ‹: 1.2TB β†’ LoRA: 350GB  
- **μ²΄ν¬ν¬μΈνΈ ν¬κΈ° κ°μ†**:  
  - \( r = 4 \), Q/V projectionλ§ ν•™μµ μ‹  
  - 350GB β†’ 35MB (μ•½ 10,000λ°° μ¶•μ†)
- **μ μ€ GPUλ΅λ„ ν•™μµ κ°€λ¥**  
  - I/O λ³‘λ© μ™„ν™”
- **νƒμ¤ν¬ μ „ν™ λΉ„μ©β†“**  
  - μ „μ²΄ λ¨λΈ κµμ²΄ λ€μ‹  LoRA λ¨λ“λ§ κµμ²΄
- **ν•™μµ μ†λ„ 25% ν–¥μƒ**  
  - λ€λ¶€λ¶„μ νλΌλ―Έν„°λ” gradient κ³„μ‚° λ¶ν•„μ”

---

#### β οΈ ν•κ³„

- μ¶”λ΅  μ†λ„ μ μ§€λ¥Ό μ„ν•΄ \( A, B \)λ¥Ό \( W \)μ— **λ³‘ν•©(merge)** ν•  κ²½μ°:
  - μ„λ΅ λ‹¤λ¥Έ νƒμ¤ν¬μ© \( A, B \)λ¥Ό ν• λ²μ— **λ°°μΉ μ²λ¦¬ν•κΈ° μ–΄λ ¤μ›€**
- λ‹¨, **μ§€μ—°μ΄ μ¤‘μ”ν•μ§€ μ•μ€ κ²½μ°**:
  - λ³‘ν•©ν•μ§€ μ•κ³  **μƒν”λ§λ‹¤ λ‹¤λ¥Έ LoRA λ¨λ“** λ™μ  μ„ νƒ κ°€λ¥


---

### π€ LORAμ μ„±λ¥ μ‹¤ν—!!

μ΄ μ—°κµ¬λ” λ‹¤μ–‘ν• νμΈνλ‹(fine-tuning) κΈ°λ²•λ“¤κ³Ό μ„±λ¥μ„ λΉ„κµν–μµλ‹λ‹¤!  
λΉ„κµ λ€μƒμΌλ΅λ” μ „ν†µμ μΈ **Full Fine-Tuning (FT)** μ„ λΉ„λ΅―ν•΄ λ‹¤μκ³Ό κ°™μ€ λ°©λ²•λ“¤μ΄ μμµλ‹λ‹¤:

- **Full Fine-Tuning (FT)**  
  λ¨λΈμ **λ¨λ“  νλΌλ―Έν„°λ¥Ό μ—…λ°μ΄νΈ**ν•λ” λ°©μ‹. κ°€μ¥ μΌλ°μ μ΄μ§€λ§, νλΌλ―Έν„° μκ°€ λ§μ•„ **λ©”λ¨λ¦¬/μ—°μ‚° λΉ„μ©μ΄ νΌ**.

- **BitFit (Bias-only Tuning)**  
  μ¤μ§ **bias ν•­λ§ ν•™μµ**ν•λ” λ°©μ‹. λ§¤μ° κ°€λ³μ§€λ§ ν‘ν„λ ¥μ€ μ ν•μ μΌ μ μμ.

- **Prefix Tuning (PreEmbed)**  
  μ…λ ¥ μ•(λλ” μ¤‘κ°„)μ— **νΉμ ν† ν°μ„ μ‚½μ…**ν•κ³ , μ΄λ“¤μ μ„λ² λ”©λ§ ν•™μµ. λ¨λΈ κµ¬μ΅°λ¥Ό μ μ§€ν•λ©΄μ„ μ μ‘ κ°€λ¥.

- **Prefix Layer Tuning (PreLayer)**  
  λ‹¨μ μ„λ² λ”©μ΄ μ•„λ‹λΌ, **κ° Transformer μΈµμ hidden activation μμ²΄λ¥Ό ν•™μµ**. λ” κ°•λ ¥ν• ν‘ν„λ ¥μ„ κ°€μ§.

- **Adapter Tuning**  
  Transformer λ‚΄λ¶€μ— **μ‘μ€ MLP κµ¬μ΅°μ μ–΄λ‘ν„° λ μ΄μ–΄**λ¥Ό μ‚½μ…ν•μ—¬ μΌλ¶€ νλΌλ―Έν„°λ§ ν•™μµ. λ‹¤μ–‘ν• λ³€ν•(AdapterH, AdapterL, AdapterP λ“±)μ΄ μμ.

- **LoRA (Low-Rank Adaptation)**  
  κΈ°μ΅΄ κ°€μ¤‘μΉ ν–‰λ ¬μ— **μ €λ­ν¬ ν–‰λ ¬ (B, A)**λ¥Ό λ³‘λ ¬λ΅ μ¶”κ°€ν•μ—¬ μΌλ¶€λ§ ν•™μµ. **μ¶”λ΅  μ†λ„ μ €ν• μ—†μ΄**, μ„±λ¥μ„ μ μ§€ν•λ©΄μ„ **νλΌλ―Έν„° μμ™€ λ©”λ¨λ¦¬ λΉ„μ©μ„ ν¬κ² μ¤„μ„**.



κ·Έλ¦¬κ³  κ²°κ³Όλ”~!

> LORAλ” μ μ€ νλΌλ―Έν„° ν•™μµμ„ ν†µν•΄ μΆ‹μ€ ν¨κ³Όλ¥Ό λ‚Έκ²ƒμ„ λ³Όμ μμ§€μ”~!  

![Image](https://github.com/user-attachments/assets/3824b21c-a1cf-44ef-aef6-f7673c8dc483)

- **GLUE benchmark (NLU κ³Όμ )** μ—μ„λ” RoBERTaμ™€ DeBERTa κΈ°λ° μ‹¤ν—μ—μ„ LoRAκ°€ Full FTμ™€ **λΉ„μ·ν•κ±°λ‚ λ” μΆ‹μ€ μ„±λ¥**μ„ λ‹¬μ„±
- **GPT-2 κΈ°λ° μƒμ„± κ³Όμ  (WikiSQL, SAMSum)** μ—μ„λ„ Prefix Tuningλ³΄λ‹¤ LoRAκ°€ **λ” λ†’μ€ BLEU/ROUGE μ„±λ¥**μ„ κΈ°λ΅
- **GPT-3 175B**μ—μ„λ” Full FTκ°€ λ¶κ°€λ¥ν• ν™κ²½μ—μ„λ„ **350GB VRAMμΌλ΅ ν•™μµ κ°€λ¥**ν•κ³ , κΈ°μ΅΄ κ²°κ³Όμ™€ μ μ‚¬ν• μ„±λ¥ ν™•λ³΄


---


### π”® κ²°λ΅ 

LoRAλ” **Transformer λ¨λΈλ“¤ (LLM, VIT, DETR λ“±λ“±)μ„ Fine-tuning ν•κΈ°μ„ν• νμ‹ μ μΈ λ°©λ²•**μ…λ‹λ‹¤!!  
νΉν **λ¨λΈ κ²½λ‰ν™”, λΉ λ¥Έ μ‹¤ν—, λ¶„μ‚° ν•™μµ, κ°μΈν™”** λ“± λ‹¤μ–‘ν• ν™μ© μ‚¬λ΅€μ— μ ν•©ν•©λ‹λ‹¤.

> "LoRAλ” LLM λ―Έμ„Έμ΅°μ •μ μƒλ΅μ΄ ν¨λ¬λ‹¤μ„μ„ μ μ‹ν•λ©°,  
> ν–¥ν›„ λ‹¤μ–‘ν• Efficient Tuning μ—°κµ¬μ κΈ°λ°μ΄ λμ—λ‹¤."

